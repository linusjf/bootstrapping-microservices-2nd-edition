#!/usr/bin/env bash

# Function to display help
show_help() {
    cat << EOF
Usage: $0 [OPTIONS]

Destroy Terraform configuration for the FlixTube application.

OPTIONS:
    --environment ENV    Set the environment (dev, stage, prod)
    -h, --help           Show this help message and exit

ENVIRONMENT VARIABLES:
    The script sources variables from .env file if present.
    Command line --environment takes precedence over .env file.

EXAMPLES:
    $0 --environment prod
    $0 --environment dev
EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --environment)
      ENVIRONMENT="$2"
      shift # past argument
      shift # past value
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      show_help
      exit 1
      ;;
  esac
done

# Source .env file if it exists (maintains existing functionality)
if [ -f .env ]; then
  source .env
fi

# Export ENVIRONMENT variable
export ENVIRONMENT

terraform destroy -auto-approve \
  -var "app_version=$VERSION" \
  -var "client_id=$ARM_CLIENT_ID" \
  -var "client_secret=$ARM_CLIENT_SECRET" \
  -var "environment=$ENVIRONMENT" \
  -var "storage_account_name=$STORAGE_ACCOUNT_NAME" \
  -var "storage_access_key=$STORAGE_ACCESS_KEY"
